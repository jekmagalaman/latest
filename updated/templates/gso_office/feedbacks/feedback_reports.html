{% extends "gso_office/gso_base_dashboard.html" %}
{% load static %}

{% block title %}Feedback Reports{% endblock %}





<!-- ===== HEADER ===== -->
{% block page_header %}
<h1 class="page-title mb-0">Client Satisfaction Feedbacks</h1>
{% endblock %}

{% block page_filter %}
<button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#csvModal">
  <i class="bi bi-download"></i> Download CSV
</button>
{% endblock %}






{% block main_content %}
<div class="container mt-4">
  <!-- TABLE -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table align-middle table-hover request-table">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Request ID</th>
            <th>Unit</th>
            <th>Requestor Name</th>
            <th>Requestor Email</th>
            <th>Average Rating</th>
            <th>Suggestions</th>
            <th>Date Submitted</th>
          </tr>
        </thead>
        <tbody>
          {% for fb in feedback_list %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ fb.request.id }}</td>
  
            <!-- UNIT -->
            <td>
              {% if fb.request.unit %}
                {{ fb.request.unit.name }}
              {% else %}
                —
              {% endif %}
            </td>
  
            <!-- NAME -->
            <td>
              {% if fb.request.custom_full_name %}
                {{ fb.request.custom_full_name }}
              {% elif fb.request.requestor %}
                {{ fb.request.requestor.get_full_name }}
              {% else %}
                —
              {% endif %}
            </td>
  
            <!-- EMAIL -->
            <td>
              {% if fb.request.custom_email %}
                {{ fb.request.custom_email }}
              {% elif fb.request.requestor %}
                {{ fb.request.requestor.email }}
              {% else %}
                —
              {% endif %}
            </td>
  
            <td>{{ fb.average_rating|default:"0.00" }}</td>
            <td>{{ fb.suggestions|default:"—" }}</td>
            <td>{{ fb.date_submitted|date:"Y-m-d H:i" }}</td>
          </tr>
  
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">No feedback submissions yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- CSV EXPORT MODAL -->
<div class="modal fade" id="csvModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" method="GET">

      <div class="modal-header">
        <h5 class="modal-title">Export Feedback CSV</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- UNIT DROPDOWN -->
        <div class="mb-3">
          <label class="form-label">Select Unit</label>
          <select class="form-select" name="unit_id">
            <option value="">All Units</option>
            {% for unit in units %}
            <option value="{{ unit.id }}">{{ unit.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- FILTER TYPE -->
        <div class="mb-3">
          <label class="form-label">Filter Type</label>
          <select id="filterType" class="form-select">
            <option value="month">Single Month</option>
            <option value="range">Date Range</option>
          </select>
        </div>

        <!-- SINGLE MONTH -->
        <div id="monthFilter" class="mb-3">
          <label class="form-label">Select Month</label>
          <input type="month" name="month" class="form-control">
        </div>

        <!-- DATE RANGE -->
        <div id="rangeFilter" class="mb-3" style="display: none;">
          <label class="form-label">From</label>
          <input type="date" name="start_date" class="form-control mb-2">

          <label class="form-label">To</label>
          <input type="date" name="end_date" class="form-control">
        </div>

      </div>

      <div class="modal-footer">
        <button type="submit" name="export" value="true" class="btn btn-success">
          <i class="bi bi-download"></i> Export CSV
        </button>
      </div>

    </form>
  </div>
</div>

<!-- Script for toggling filter UI -->
<script>
document.getElementById("filterType").addEventListener("change", function () {
  const type = this.value;
  document.getElementById("monthFilter").style.display = type === "month" ? "block" : "none";
  document.getElementById("rangeFilter").style.display = type === "range" ? "block" : "none";
});
</script>

{% endblock %}














