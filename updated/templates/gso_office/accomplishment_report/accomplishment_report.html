{% extends "gso_office/gso_base_dashboard.html" %}

{% block title %}Work Accomplishment Report{% endblock %}

<!-- ======= PAGE HEADER ======= -->
{% block page_header %}
<h1 class="page-title mb-0">Work Accomplishment Report</h1>
{% endblock %}

<!-- ======= PAGE FILTERS ======= -->
{% block page_filter %}
<form method="get" class="d-flex gap-2 align-items-center filter-form">
  <input 
    type="text" 
    name="user_status" 
    class="form-control form-control-sm" 
    placeholder="Search reports..." 
    value="{{ request.GET.user_status }}">

  <select name="unit" class="form-select form-select-sm" onchange="this.form.submit()">
    <option value="">All Units</option>
    <option value="repair and maintenance" {% if request.GET.unit == 'repair and maintenance' %}selected{% endif %}>Repair and Maintenance</option>
    <option value="utility" {% if request.GET.unit == 'utility' %}selected{% endif %}>Utility</option>
    <option value="electrical" {% if request.GET.unit == 'electrical' %}selected{% endif %}>Electrical</option>
    <option value="motorpool" {% if request.GET.unit == 'motorpool' %}selected{% endif %}>Motorpool</option>
  </select>
</form>

<button type="button" class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#reportModal">
  <i class="bi bi-file-earmark-bar-graph me-2"></i> Generate Report
</button>
{% endblock %}

<!-- ======= MAIN CONTENT ======= -->
{% block main_content %}

<!-- ======= REPORT GENERATION MODAL ======= -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="get" action="{% url 'gso_reports:preview_report' %}">
        <div class="modal-header">
          <h5 class="modal-title fw-semibold">Generate Report</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <!-- Report Type -->
          <div class="mb-3">
            <label for="report_type" class="form-label">Select Report Type</label>
            <select name="report_type" id="report_type" class="form-select" onchange="togglePersonnelSelection()">
              <option value="ipmt" selected>IPMT</option>
              <option value="war">Work Accomplishment Report</option>
            </select>
          </div>

          <!-- Unit Selection -->
          <div class="mb-3">
            <label for="unit" class="form-label">Select Unit</label>
            <select name="unit" id="unit" class="form-select" onchange="filterPersonnel()">
              <option value="">All Units</option>
              <option value="repair and maintenance">Repair and Maintenance</option>
              <option value="utility">Utility</option>
              <option value="electrical">Electrical</option>
              <option value="motorpool">Motorpool</option>
            </select>
          </div>

          <!-- Personnel Selection (optional) -->
          <div class="mb-3" id="personnel-wrapper">
            <label class="form-label">Select Personnel (optional)</label>
            <div id="personnel-container" class="d-flex flex-column border rounded p-3" style="max-height:200px; overflow-y:auto;"></div>
            <small class="text-muted">You may select multiple personnel.</small>
          </div>

          <!-- Month -->
          <div class="mb-3">
            <label for="month" class="form-label">Select Month</label>
            <input type="month" name="month" id="month" class="form-control" required>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success px-4">
            <i class="bi bi-eye me-1"></i> Generate Preview
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ======= REPORTS TABLE ======= -->
<div class="table-responsive mt-3">
  <table class="table align-middle table-hover request-table">
    <thead class="table-light">
      <tr>
        <th>Date</th>
        <th>Unit</th>
        <th>Description</th>
        <th>Requesting Office</th>
        <th>Personnel</th>
        <th>Status</th>
        <th>Rating</th>
        <th>Success Indicator</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody>
      {% if reports %}
        {% for report in reports %}
        <tr>
          <td>{{ report.date|date:"Y-m-d" }}</td>
          <td><span class="fw-semibold">{{ report.unit|title }}</span></td>
          <td>
            <span class="war-desc" id="war-description-{{ report.id }}" data-id="{{ report.id }}" data-type="{{ report.type }}">
              {% if report.type == "WorkAccomplishmentReport" %}
                <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                Generating AI description...
              {% else %}
                {{ report.display_description|default:"(No description)" }}
              {% endif %}
            </span>
          </td>
          <td>{{ report.requesting_office }}</td>
          <td>
            {% for p in report.personnel %}
              <span class="badge bg-light text-dark border me-1">{{ p }}</span>
            {% endfor %}
          </td>
          <td><span class="badge bg-info text-dark">{{ report.status|default:"Completed" }}</span></td>
          <td>{{ report.rating|default:"Not Rated" }}</td>
          <td>
            {% if report.type == "WorkAccomplishmentReport" %}
              {{ report.success_indicator.code|default:"Pending" }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if report.request %}
              <span class="badge bg-success">Live</span>
            {% else %}
              <span class="badge bg-secondary">Migrated</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="9" class="text-center text-muted py-4">No reports available.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- ======= PERSONNEL JSON ======= -->
{{ personnel_list|json_script:"personnel-data" }}

<script>
const personnelList = JSON.parse(document.getElementById('personnel-data').textContent);
const personnelData = {};

// Prepare personnel grouped by unit
personnelList.forEach(p => {
  const unit = p.unit || 'unassigned';
  if (!personnelData[unit]) personnelData[unit] = [];
  personnelData[unit].push({
    name: p.full_name || p.username,
    safeId: (p.full_name || p.username).replace(/\s+/g, '-')
  });
});

const personnelContainer = document.getElementById('personnel-container');
const personnelWrapper = document.getElementById('personnel-wrapper');

// Filter personnel based on selected unit
function filterPersonnel() {
  const selectedUnit = document.getElementById('unit').value || '';
  personnelContainer.innerHTML = "";

  const list = selectedUnit && personnelData[selectedUnit] ? personnelData[selectedUnit] : Object.values(personnelData).flat();

  if (!list.length) {
    personnelContainer.innerHTML = "<p class='text-muted'>No personnel available</p>";
    return;
  }

  list.forEach(p => {
    const div = document.createElement("div");
    div.classList.add("form-check");
    div.innerHTML = `
      <input class="form-check-input" type="checkbox" name="personnel[]" value="${p.name}" id="person_${p.safeId}">
      <label class="form-check-label" for="person_${p.safeId}">${p.name}</label>
    `;
    personnelContainer.appendChild(div);
  });
}

// Toggle personnel selection visibility depending on report type
function togglePersonnelSelection() {
  const reportType = document.getElementById('report_type').value;
  personnelWrapper.style.display = reportType === 'ipmt' ? 'block' : 'none';
}

// Fetch WAR description dynamically
async function fetchWarDescription(warId, retries = 15) {
  if (retries <= 0) return;
  try {
    const res = await fetch(`/gso_reports/war-description/${warId}/`);
    const data = await res.json();
    if (data.description?.trim()) {
      document.getElementById(`war-description-${warId}`).innerHTML = data.description;
    } else {
      setTimeout(() => fetchWarDescription(warId, retries - 1), 2000);
    }
  } catch {
    setTimeout(() => fetchWarDescription(warId, retries - 1), 2000);
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  filterPersonnel();
  togglePersonnelSelection();
  {% for report in reports %}
    {% if report.type == "WorkAccomplishmentReport" %}
      fetchWarDescription({{ report.id }});
    {% endif %}
  {% endfor %}
});
</script>

{% endblock %}
