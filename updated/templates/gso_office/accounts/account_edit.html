{% extends "gso_office/gso_base_dashboard.html" %}
{% load widget_tweaks %}

{% block title %}Edit User{% endblock %}

{% block page_header %}
<h1 class="page-title mb-0">
  <i></i>Edit User â€”
  {% if user.role == "requestor" %}
    {{ user.department }}
  {% else %}
    {{ user.get_full_name }}
  {% endif %}
</h1>
{% endblock %}

{% block main_content %}
<div class="container mt-4 mb-5">
  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">

    <!-- Body -->
    <div class="card-body px-4 py-4 bg-white">
      <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}

        <div class="row g-3">
          <!-- Role -->
          <div class="col-md-6">
            <label for="id_role" class="form-label fw-semibold text-uppercase text-primary small">Role</label>
            {{ form.role|add_class:"form-select shadow-sm" }}
          </div>

          <!-- Unit -->
          <div class="col-md-6" id="unitField">
            <label for="id_unit" class="form-label fw-semibold text-uppercase text-primary small">Unit</label>
            {{ form.unit|add_class:"form-select shadow-sm" }}
          </div>

          <!-- First Name -->
          <div class="col-md-6" id="firstNameField">
            <label for="id_first_name" class="form-label fw-semibold text-uppercase text-primary small">First Name</label>
            {{ form.first_name|add_class:"form-control shadow-sm" }}
          </div>

          <!-- Username -->
          <div class="col-md-6" id="usernameField">
            <label for="id_username" class="form-label fw-semibold text-uppercase text-primary small">Username</label>
            {{ form.username|add_class:"form-control shadow-sm" }}
          </div>

          <!-- Last Name -->
          <div class="col-md-6" id="lastNameField">
            <label for="id_last_name" class="form-label fw-semibold text-uppercase text-primary small">Last Name</label>
            {{ form.last_name|add_class:"form-control shadow-sm" }}
          </div>

          <!-- Department -->
          <div class="col-md-6" id="deptField">
            <label for="id_department" class="form-label fw-semibold text-uppercase text-primary small">Department</label>
            {{ form.department|add_class:"form-select shadow-sm" }}
          </div>

          <!-- Position -->
          <div class="col-md-6" id="positionField">
            <label for="id_position" class="form-label fw-semibold text-uppercase text-primary small">Position</label>
            {{ form.position|add_class:"form-select shadow-sm" }}
          </div>

          <!-- Employment Status -->
          <div class="col-md-6" id="employmentStatusField">
            <label for="id_employment_status" class="form-label fw-semibold text-uppercase text-primary small">Employment Status</label>
            {{ form.employment_status|add_class:"form-select shadow-sm" }}
          </div>


          <!-- Status -->
          <div class="col-md-6">
            <label for="id_account_status" class="form-label fw-semibold text-uppercase text-primary small">Status</label>
            {{ form.account_status|add_class:"form-select shadow-sm" }}
          </div>
        </div>

        <!-- Buttons -->
        <div class="mt-5 d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-success px-4 py-2 shadow-sm d-flex align-items-center">
            <i class="bi bi-save me-2"></i> Save Changes
          </button>
          <a href="{% url 'gso_accounts:account_management' %}" class="btn btn-outline-secondary px-4 py-2 shadow-sm d-flex align-items-center">
            <i class="bi bi-x-lg me-2"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ===== Script for Dynamic Field Visibility ===== -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  const roleField = document.getElementById("id_role");
  const username = document.getElementById("usernameField");
  const firstName = document.getElementById("firstNameField");
  const lastName = document.getElementById("lastNameField");
  const unitField = document.getElementById("unitField");
  const deptField = document.getElementById("deptField");
  const positionField = document.getElementById("positionField");
  const employmentField = document.getElementById("employmentStatusField");

  function toggleFields() {
    
    const role = roleField.value;

    // Default visibility (show all)
    username.style.display = "block";
    firstName.style.display = "block";
    lastName.style.display = "block";
    unitField.style.display = "block";
    deptField.style.display = "block";
    positionField.style.display = "block";
    employmentField.style.display = "block";

    // ============================
    // REQUESTOR
    // ============================
    if (role === "requestor") {
      firstName.style.display = "none";
      lastName.style.display = "none";
      unitField.style.display = "none";
      positionField.style.display = "none";
      employmentField.style.display = "none";

      deptField.style.display = "block"; // Requestor uses department
    }

    // ============================
    // DIRECTOR
    // ============================
    else if (role === "director") {
      unitField.style.display = "none";
      deptField.style.display = "none";
      positionField.style.display = "none";
      employmentField.style.display = "none";

      firstName.style.display = "block";
      lastName.style.display = "block";
    }

    // ============================
    // GSO OFFICE
    // ============================
    else if (role === "gso") {
      unitField.style.display = "none";
      deptField.style.display = "none";

      positionField.style.display = "block";
      employmentField.style.display = "block";
    }

    // ============================
    // UNIT HEAD & PERSONNEL
    // ============================
    else if (role === "unit_head" || role === "personnel") {

      unitField.style.display = "block";
      positionField.style.display = "block";
      employmentField.style.display = "block";

      deptField.style.display = "none";
    }
  }

  toggleFields();
  roleField.addEventListener("change", toggleFields);

});



// Password toggle
const newPasswordInput = document.getElementById("id_new_password");
const toggleNewPassword = document.getElementById("toggleNewPassword");
toggleNewPassword.addEventListener("click", function () {
    const type = newPasswordInput.type === "password" ? "text" : "password";
    newPasswordInput.type = type;
    this.classList.toggle("bi-eye-slash");
});

const confirmPasswordInput = document.getElementById("id_confirm_password");
const toggleConfirmPassword = document.getElementById("toggleConfirmPassword");
toggleConfirmPassword.addEventListener("click", function () {
    const type = confirmPasswordInput.type === "password" ? "text" : "password";
    confirmPasswordInput.type = type;
    this.classList.toggle("bi-eye-slash");
});

</script>

{% endblock %}
